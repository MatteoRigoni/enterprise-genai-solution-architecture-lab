@using AiSa.Host.Services
@using Microsoft.FluentUI.AspNetCore.Components

<div class="recent-calls-table">
    <table class="calls-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Method</th>
                <th>Path</th>
                <th>Status</th>
                <th>Duration</th>
            </tr>
        </thead>
        <tbody>
            @if (calls != null && calls.Count > 0)
            {
                @foreach (var call in calls.OrderByDescending(c => c.Timestamp).Take(5))
                {
                    <tr>
                        <td>@FormatRelativeTime(call.Timestamp)</td>
                        <td><span class="method-badge method-@call.Method.ToLowerInvariant()">@call.Method</span></td>
                        <td class="path-cell">@call.Path</td>
                        <td><span class="status-badge status-@GetStatusClass(call.StatusCode)">@call.StatusCode</span></td>
                        <td>@call.DurationMs ms</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="5" class="empty-state">No API calls yet</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    [Parameter]
    public IReadOnlyList<ApiCallRecord>? Calls { get; set; }

    private IReadOnlyList<ApiCallRecord> calls => Calls ?? Array.Empty<ApiCallRecord>();

    private string FormatRelativeTime(DateTimeOffset timestamp)
    {
        var now = DateTimeOffset.UtcNow;
        var diff = now - timestamp;

        if (diff.TotalSeconds < 60)
        {
            var seconds = (int)diff.TotalSeconds;
            return seconds == 0 ? "now" : $"{seconds}s ago";
        }
        else if (diff.TotalMinutes < 60)
        {
            var minutes = (int)diff.TotalMinutes;
            return $"{minutes}m ago";
        }
        else
        {
            var hours = (int)diff.TotalHours;
            return $"{hours}h ago";
        }
    }

    private string GetStatusClass(int statusCode)
    {
        if (statusCode >= 200 && statusCode < 300)
            return "success";
        else if (statusCode >= 400 && statusCode < 500)
            return "warning";
        else if (statusCode >= 500)
            return "error";
        else
            return "info";
    }
}

